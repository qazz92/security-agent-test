"""
GitHub ì—°ë™ íˆ´
ì‹¤ì œ GitHub Repositoryì— PR, Issue ìƒì„±

ì¸ì¦ ë°©ë²•:
1. GitHub CLI (gh) - ìë™ ì¸ì¦ (ê¶Œì¥)
2. GitHub PAT - í™˜ê²½ ë³€ìˆ˜ë¡œ ì œê³µ
"""

import os
import json
import subprocess
import requests
from typing import Dict, Any, Optional, List
from langchain_core.tools import BaseTool
from pydantic import BaseModel, Field


class CreateGitHubPRInput(BaseModel):
    """Input schema for create_github_pr tool"""
    repo_url: str = Field(
        description="GitHub ì €ì¥ì†Œ URL (ì˜ˆ: https://github.com/qazz92/security-agent-test)"
    )
    branch_name: str = Field(
        default="security-fixes",
        description="PRì„ ìœ„í•œ ìƒˆ ë¸Œëœì¹˜ ì´ë¦„"
    )
    pr_title: str = Field(
        description="PR ì œëª©"
    )
    pr_body: str = Field(
        description="PR ë³¸ë¬¸ (ë§ˆí¬ë‹¤ìš´)"
    )
    base_branch: str = Field(
        default="main",
        description="ë² ì´ìŠ¤ ë¸Œëœì¹˜ (main, master ë“±)"
    )


class CreateGitHubPRTool(BaseTool):
    """GitHubì— ì‹¤ì œ Pull Requestë¥¼ ìƒì„±í•˜ëŠ” ë„êµ¬"""

    name: str = "create_github_pr"
    description: str = """
    GitHub Pull Request í…œí”Œë¦¿ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.

    ìƒì„±ë˜ëŠ” íŒŒì¼:
    - /app/results/pr_template_{timestamp}.md
    - PR ì œëª©, ë³¸ë¬¸, ìƒì„± ë°©ë²• í¬í•¨
    - GitHub CLI, Web UI, API ì‚¬ìš© ë°©ë²• ì•ˆë‚´

    ì‹¤ì œ PR ìƒì„±ì€ ì‚¬ìš©ìê°€ ì§ì ‘ ìˆ˜í–‰:
    - ì˜µì…˜ 1: GitHub CLI (gh pr create)
    - ì˜µì…˜ 2: GitHub Web UI
    - ì˜µì…˜ 3: GitHub API (curl)
    """
    args_schema: type[BaseModel] = CreateGitHubPRInput

    def _run(
        self,
        repo_url: str,
        pr_title: str,
        pr_body: str,
        branch_name: str = "security-fixes",
        base_branch: str = "main"
    ) -> Dict[str, Any]:
        """
        GitHub PR í…œí”Œë¦¿ íŒŒì¼ ìƒì„±

        Args:
            repo_url: GitHub ì €ì¥ì†Œ URL
            pr_title: PR ì œëª©
            pr_body: PR ë³¸ë¬¸
            branch_name: ìƒˆ ë¸Œëœì¹˜ ì´ë¦„
            base_branch: ë² ì´ìŠ¤ ë¸Œëœì¹˜

        Returns:
            PR í…œí”Œë¦¿ íŒŒì¼ ìƒì„± ê²°ê³¼
        """
        import datetime

        try:
            # results ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±
            results_dir = "/app/results"
            os.makedirs(results_dir, exist_ok=True)

            # íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
            timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")

            # PR í…œí”Œë¦¿ íŒŒì¼ ìƒì„±
            pr_file_path = os.path.join(results_dir, f"pr_template_{timestamp}.md")

            # ì €ì¥ì†Œì—ì„œ owner/repo ì¶”ì¶œ
            repo_path = self._extract_repo_path(repo_url)

            # PR í…œí”Œë¦¿ ë‚´ìš© êµ¬ì„±
            pr_template = f"""# Pull Request Template

## Repository Information
- **Repository**: {repo_url}
- **Owner/Repo**: {repo_path}
- **Base Branch**: {base_branch}
- **Branch Name**: {branch_name}
- **Generated**: {timestamp}

---

# {pr_title}

{pr_body}

---

## How to Create This PR

### Option 1: Using GitHub CLI (Recommended)
```bash
# Clone the repository
git clone {repo_url}
cd {repo_path.split('/')[-1]}

# Create and switch to the branch
git checkout -b {branch_name}

# Apply your fixes (generated code from security scan)
# ... copy fix files here ...

# Commit changes
git add .
git commit -m "{pr_title}"

# Push to remote
git push -u origin {branch_name}

# Create PR using GitHub CLI
gh pr create \\
  --base {base_branch} \\
  --head {branch_name} \\
  --title "{pr_title}" \\
  --body-file {pr_file_path}
```

### Option 2: Using GitHub Web UI
1. Clone repository: `git clone {repo_url}`
2. Create branch: `git checkout -b {branch_name}`
3. Apply fixes and commit changes
4. Push: `git push -u origin {branch_name}`
5. Go to {repo_url}/pulls
6. Click "New Pull Request"
7. Select base: `{base_branch}` and compare: `{branch_name}`
8. Copy the content below into PR description

### Option 3: Using GitHub API
```bash
# Set your GitHub token
export GITHUB_TOKEN="your_github_token_here"

# Clone and prepare branch
git clone {repo_url}
cd {repo_path.split('/')[-1]}
git checkout -b {branch_name}

# Apply fixes and commit
git add .
git commit -m "{pr_title}"
git push -u origin {branch_name}

# Create PR via API
curl -X POST \\
  -H "Authorization: token $GITHUB_TOKEN" \\
  -H "Accept: application/vnd.github.v3+json" \\
  https://api.github.com/repos/{repo_path}/pulls \\
  -d '{{
    "title": "{pr_title}",
    "body": "See {pr_file_path} for full details",
    "head": "{branch_name}",
    "base": "{base_branch}"
  }}'
```

---

## ğŸ¤– Generated by AI Security Agent Portfolio
"""

            # íŒŒì¼ ì €ì¥
            with open(pr_file_path, 'w', encoding='utf-8') as f:
                f.write(pr_template)

            print(f"âœ… PR template saved to: {pr_file_path}")

            return {
                "success": True,
                "pr_template_file": pr_file_path,
                "repo_url": repo_url,
                "repo_path": repo_path,
                "base_branch": base_branch,
                "branch_name": branch_name,
                "pr_title": pr_title,
                "message": f"PR template saved to {pr_file_path}. Use GitHub CLI, Web UI, or API to create the actual PR.",
                "instructions": {
                    "github_cli": f"gh pr create --base {base_branch} --head {branch_name} --title \"{pr_title}\" --body-file {pr_file_path}",
                    "web_ui": f"{repo_url}/compare/{base_branch}...{branch_name}?expand=1",
                    "file_location": pr_file_path
                }
            }

        except Exception as e:
            return {
                "success": False,
                "error": f"Failed to create PR template: {str(e)}",
                "message": "An error occurred while creating PR template file"
            }

    def _check_github_cli(self) -> bool:
        """GitHub CLI ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸"""
        try:
            # gh ì„¤ì¹˜ í™•ì¸
            subprocess.run(['gh', '--version'], capture_output=True, check=True, timeout=5)

            # ì¸ì¦ í™•ì¸
            auth_check = subprocess.run(
                ['gh', 'auth', 'status'],
                capture_output=True,
                text=True,
                timeout=5
            )

            return auth_check.returncode == 0

        except (FileNotFoundError, subprocess.CalledProcessError, subprocess.TimeoutExpired):
            return False

    def _create_pr_with_cli(
        self,
        repo_path: str,
        base_branch: str,
        branch_name: str,
        pr_title: str,
        pr_body: str,
        has_changes: bool
    ) -> Dict[str, Any]:
        """GitHub CLIë¡œ PR ìƒì„±"""
        import tempfile

        # PR ë³¸ë¬¸ì„ ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
            f.write(pr_body)
            body_file = f.name

        try:
            pr_result = subprocess.run(
                [
                    'gh', 'pr', 'create',
                    '--repo', repo_path,
                    '--base', base_branch,
                    '--head', branch_name,
                    '--title', pr_title,
                    '--body-file', body_file
                ],
                capture_output=True,
                text=True,
                timeout=30
            )

            if pr_result.returncode == 0:
                pr_url = pr_result.stdout.strip()
                return {
                    "success": True,
                    "pr_url": pr_url,
                    "branch": branch_name,
                    "base_branch": base_branch,
                    "message": f"Pull Request created successfully: {pr_url}",
                    "commits": 1 if has_changes else 0,
                    "method": "github_cli"
                }
            else:
                return {
                    "success": False,
                    "error": "Failed to create PR with GitHub CLI",
                    "details": pr_result.stderr,
                    "branch_pushed": True,
                    "message": f"Branch '{branch_name}' was pushed but PR creation failed."
                }

        finally:
            os.unlink(body_file)

    def _create_pr_with_api(
        self,
        repo_path: str,
        base_branch: str,
        branch_name: str,
        pr_title: str,
        pr_body: str,
        github_token: str,
        has_changes: bool
    ) -> Dict[str, Any]:
        """GitHub APIë¡œ ì§ì ‘ PR ìƒì„±"""

        # API endpoint
        api_url = f"https://api.github.com/repos/{repo_path}/pulls"

        # Headers
        headers = {
            "Authorization": f"token {github_token}",
            "Accept": "application/vnd.github.v3+json",
            "User-Agent": "SecurityAgent"
        }

        # Request body
        data = {
            "title": pr_title,
            "body": pr_body,
            "head": branch_name,
            "base": base_branch
        }

        try:
            response = requests.post(api_url, headers=headers, json=data, timeout=30)

            if response.status_code == 201:
                pr_data = response.json()
                return {
                    "success": True,
                    "pr_url": pr_data["html_url"],
                    "pr_number": pr_data["number"],
                    "branch": branch_name,
                    "base_branch": base_branch,
                    "message": f"Pull Request created successfully: {pr_data['html_url']}",
                    "commits": 1 if has_changes else 0,
                    "method": "github_api"
                }
            elif response.status_code == 422:
                # PRì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°
                error_data = response.json()
                return {
                    "success": False,
                    "error": "PR already exists or validation failed",
                    "details": error_data.get("message", ""),
                    "errors": error_data.get("errors", []),
                    "branch_pushed": True,
                    "message": "Branch was pushed but PR creation failed. A PR might already exist for this branch."
                }
            else:
                return {
                    "success": False,
                    "error": f"GitHub API returned {response.status_code}",
                    "details": response.text,
                    "branch_pushed": True
                }

        except requests.RequestException as e:
            return {
                "success": False,
                "error": "Failed to create PR via GitHub API",
                "details": str(e),
                "branch_pushed": True
            }

    def _extract_repo_path(self, repo_url: str) -> str:
        """
        GitHub URLì—ì„œ owner/repo ì¶”ì¶œ

        Args:
            repo_url: GitHub ì €ì¥ì†Œ URL

        Returns:
            owner/repo í˜•ì‹ ë¬¸ìì—´
        """
        # https://github.com/qazz92/security-agent-test â†’ qazz92/security-agent-test
        # git@github.com:qazz92/security-agent-test.git â†’ qazz92/security-agent-test

        repo_url = repo_url.rstrip('/')

        if repo_url.startswith('https://github.com/'):
            path = repo_url.replace('https://github.com/', '')
        elif repo_url.startswith('git@github.com:'):
            path = repo_url.replace('git@github.com:', '')
        else:
            # ì´ë¯¸ owner/repo í˜•ì‹ì´ë¼ê³  ê°€ì •
            return repo_url

        # .git ì œê±°
        path = path.replace('.git', '')

        return path


class CreateGitHubIssueInput(BaseModel):
    """Input schema for create_github_issue tool"""
    repo_url: str = Field(
        description="GitHub ì €ì¥ì†Œ URL"
    )
    issue_title: str = Field(
        description="Issue ì œëª©"
    )
    issue_body: str = Field(
        description="Issue ë³¸ë¬¸ (ë§ˆí¬ë‹¤ìš´)"
    )
    labels: Optional[List[str]] = Field(
        default=None,
        description="Issue ë¼ë²¨ ë¦¬ìŠ¤íŠ¸ (ì˜ˆ: ['security', 'bug'])"
    )


class CreateGitHubIssueTool(BaseTool):
    """GitHubì— Issueë¥¼ ìƒì„±í•˜ëŠ” ë„êµ¬"""

    name: str = "create_github_issue"
    description: str = "GitHub Repositoryì— Issueë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ë³´ì•ˆ ì·¨ì•½ì  ë³´ê³  ë“±ì— ì‚¬ìš©."
    args_schema: type[BaseModel] = CreateGitHubIssueInput

    def _run(
        self,
        repo_url: str,
        issue_title: str,
        issue_body: str,
        labels: Optional[List[str]] = None
    ) -> Dict[str, Any]:
        """
        GitHub Issue ìƒì„±

        Args:
            repo_url: GitHub ì €ì¥ì†Œ URL
            issue_title: Issue ì œëª©
            issue_body: Issue ë³¸ë¬¸
            labels: ë¼ë²¨ ë¦¬ìŠ¤íŠ¸

        Returns:
            Issue ìƒì„± ê²°ê³¼
        """
        try:
            # GitHub CLI í™•ì¸
            try:
                subprocess.run(['gh', '--version'], capture_output=True, check=True, timeout=5)
            except (FileNotFoundError, subprocess.CalledProcessError):
                return {
                    "success": False,
                    "error": "GitHub CLI (gh) not installed"
                }

            # ì €ì¥ì†Œ ê²½ë¡œ ì¶”ì¶œ
            pr_tool = CreateGitHubPRTool()
            repo_path = pr_tool._extract_repo_path(repo_url)

            # Issue ë³¸ë¬¸ì„ ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
            import tempfile
            with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False) as f:
                f.write(issue_body)
                body_file = f.name

            try:
                # GitHub CLIë¡œ Issue ìƒì„±
                cmd = [
                    'gh', 'issue', 'create',
                    '--repo', repo_path,
                    '--title', issue_title,
                    '--body-file', body_file
                ]

                # ë¼ë²¨ ì¶”ê°€
                if labels:
                    for label in labels:
                        cmd.extend(['--label', label])

                issue_result = subprocess.run(
                    cmd,
                    capture_output=True,
                    text=True,
                    timeout=30
                )

                if issue_result.returncode == 0:
                    issue_url = issue_result.stdout.strip()
                    return {
                        "success": True,
                        "issue_url": issue_url,
                        "message": f"Issue created successfully: {issue_url}"
                    }
                else:
                    return {
                        "success": False,
                        "error": "Failed to create issue",
                        "details": issue_result.stderr
                    }

            finally:
                os.unlink(body_file)

        except Exception as e:
            return {
                "success": False,
                "error": f"Unexpected error: {str(e)}"
            }


# Tool instances for backward compatibility
_create_github_pr_tool = CreateGitHubPRTool()
_create_github_issue_tool = CreateGitHubIssueTool()

# CrewAI-compatible tool wrappers
from crewai.tools import tool

@tool("Create GitHub PR")
def create_github_pr(
    repo_url: str,
    pr_title: str,
    pr_body: str,
    branch_name: str = "security-fixes",
    base_branch: str = "main"
) -> dict:
    """GitHub Repositoryì— Pull Requestë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ë³´ì•ˆ íŒ¨ì¹˜ë¥¼ ìœ„í•œ ë¸Œëœì¹˜ ìƒì„±, ì»¤ë°‹, í‘¸ì‹œ ë° PR ìƒì„±ê¹Œì§€ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤. GitHub CLI ë˜ëŠ” GITHUB_TOKEN í™˜ê²½ ë³€ìˆ˜ë¥¼ í†µí•´ ì¸ì¦í•©ë‹ˆë‹¤."""
    return _create_github_pr_tool._run(
        repo_url=repo_url,
        pr_title=pr_title,
        pr_body=pr_body,
        branch_name=branch_name,
        base_branch=base_branch
    )

@tool("Create GitHub Issue")
def create_github_issue(
    repo_url: str,
    issue_title: str,
    issue_body: str,
    labels: Optional[List[str]] = None
) -> dict:
    """GitHub Repositoryì— Issueë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ë³´ì•ˆ ì·¨ì•½ì  ë³´ê³ ë‚˜ ê°œì„  ì œì•ˆ ë“±ì„ ì´ìŠˆë¡œ ë“±ë¡í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. GitHub CLIë¥¼ í†µí•´ ì¸ì¦í•©ë‹ˆë‹¤."""
    return _create_github_issue_tool._run(
        repo_url=repo_url,
        issue_title=issue_title,
        issue_body=issue_body,
        labels=labels
    )