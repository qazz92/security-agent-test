"""
ì‹¤ì œ GitHub PR ìƒì„± í…ŒìŠ¤íŠ¸
"""
import os
from dotenv import load_dotenv
from src.tools.github_tools import create_github_pr

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

print("="*70)
print("ğŸš€ GitHub PR ìƒì„± í…ŒìŠ¤íŠ¸")
print("="*70)

# í† í° í™•ì¸
token = os.environ.get('GITHUB_TOKEN')
if token:
    print(f"âœ… GitHub Token ì„¤ì •ë¨: {token[:10]}...")
else:
    print("âŒ GITHUB_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!")
    exit(1)

# PR ë³¸ë¬¸
pr_body = """## ğŸ” Security Vulnerabilities Fixed

### ğŸ“Š Summary
This PR addresses critical security vulnerabilities found by SecurityAgent:
- **Total vulnerabilities**: 12
- **Critical**: 4 ğŸš¨
- **High**: 6 âš ï¸
- **Medium**: 2 ğŸ“‹

### ğŸ”§ Changes Made
1. **SQL Injection** - Fixed parameterized queries in `app.py:57`
2. **XSS Vulnerability** - Added input sanitization in `app.py:99`
3. **Hardcoded Secrets** - Moved to environment variables
4. **Dependency Updates**:
   - Flask: 1.0.0 â†’ 3.0.0 (CVE-2019-1010083)
   - requests: 2.19.0 â†’ 2.31.0 (CVE-2018-18074)
   - PyYAML: 3.13 â†’ 6.0.1 (CVE-2017-18342)

### ğŸ§ª Testing
- [x] All existing tests pass
- [x] Security scan with Trivy shows no critical vulnerabilities
- [x] Manual testing completed
- [x] Code review performed

### ğŸ”’ Security Checklist
- [x] No hardcoded secrets in code
- [x] All user inputs are validated and sanitized
- [x] Database queries use parameterized statements
- [x] Error messages don't expose sensitive information
- [x] Security headers properly configured

### ğŸ“š References
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [SecurityAgent Documentation](https://github.com/qazz92/security-agent-test)

---

ğŸ¤– **This PR was automatically generated by [SecurityAgent](https://github.com/qazz92/security-agent-portfolio)**

âš ï¸ Please review carefully before merging to production.
"""

# PR ìƒì„± ì‹œë„
print("\nğŸ“ PR ì •ë³´:")
print(f"   Repository: https://github.com/qazz92/security-agent-test")
print(f"   Branch: security-fixes â†’ main")
print(f"   Title: ğŸ”’ Fix 12 Critical Security Vulnerabilities")
print()

result = create_github_pr._run(
    repo_url="https://github.com/qazz92/security-agent-test",
    pr_title="ğŸ”’ Fix 12 Critical Security Vulnerabilities",
    pr_body=pr_body,
    branch_name="security-fixes",
    base_branch="main"
)

print("\n" + "="*70)
print("ğŸ“Š ê²°ê³¼:")
print("="*70)

if result.get("success"):
    print(f"âœ… PR ìƒì„± ì„±ê³µ!")
    print(f"ğŸ”— PR URL: {result.get('pr_url')}")
    print(f"ğŸŒ¿ Branch: {result.get('branch')}")
    print(f"ğŸ“ Base: {result.get('base_branch')}")
    print(f"ğŸ”§ Method: {result.get('method')}")
else:
    print(f"âŒ PR ìƒì„± ì‹¤íŒ¨")
    print(f"Error: {result.get('error')}")
    if result.get('details'):
        print(f"Details: {result.get('details')}")
    if result.get('message'):
        print(f"Message: {result.get('message')}")

print("="*70)