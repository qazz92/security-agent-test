# 🚀 GitHub PR 자동 생성 가이드

SecurityAgent는 보안 취약점을 분석하고 **실제 GitHub Pull Request를 자동으로 생성**할 수 있습니다!

---

## 📋 사전 요구사항

### 1. GitHub CLI 설치

```bash
# macOS
brew install gh

# Ubuntu/Debian
sudo apt install gh

# Windows
winget install --id GitHub.cli
```

설치 확인:
```bash
gh --version
# gh version 2.40.0 (2024-01-01)
```

### 2. GitHub 인증

```bash
gh auth login
```

인터랙티브 프롬프트를 따라 진행:
1. GitHub.com 선택
2. HTTPS 선택
3. 브라우저에서 인증
4. Git credential helper 사용: Yes

인증 확인:
```bash
gh auth status
# ✓ Logged in to github.com as qazz92
```

### 3. Git Repository 설정

프로젝트 디렉토리가 Git repository여야 합니다:

```bash
cd security-agent-portfolio

# 저장소 초기화 (아직 안했다면)
git init

# 원격 저장소 연결
git remote add origin https://github.com/qazz92/security-agent-test.git

# 원격 저장소 확인
git remote -v
# origin  https://github.com/qazz92/security-agent-test.git (fetch)
# origin  https://github.com/qazz92/security-agent-test.git (push)
```

---

## 🎯 사용 방법

### 방법 1: Agent가 자동으로 PR 생성 (권장)

Agent에게 GitHub 저장소 URL과 함께 요청하면 자동으로 PR을 생성합니다:

```python
import asyncio
from src.agents.orchestrator_agent import SecurityOrchestrator

async def main():
    orchestrator = SecurityOrchestrator(verbose=True)

    # GitHub 저장소 URL을 포함한 쿼리
    query = """
    Comprehensive security analysis for:
    https://github.com/qazz92/security-agent-test

    After analysis, please create a GitHub Pull Request with the fixes.
    """

    result = await orchestrator.analyze_and_remediate(
        'demo/hello-world-vulnerable',
        query
    )

    print("PR URL:", result.get("remediation_plan", {}).get("pr_url"))

asyncio.run(main())
```

### 방법 2: CLI에서 직접 실행

```bash
python test_github_pr.py
```

### 방법 3: Tool을 직접 사용

```python
from src.tools.github_tools import create_github_pr

result = create_github_pr._run(
    repo_url="https://github.com/qazz92/security-agent-test",
    pr_title="🔒 Fix Critical Security Vulnerabilities",
    pr_body="""## 🔐 Security Patch

### Summary
- Fixed 12 security vulnerabilities
- Updated vulnerable dependencies
- Added input validation

### Testing
- [x] All tests pass
- [x] Security scan clean

🤖 Generated by SecurityAgent
    """,
    branch_name="security-fixes",
    base_branch="main"
)

print("PR Created:", result["pr_url"])
```

---

## 🔄 자동 PR 생성 프로세스

SecurityAgent가 자동으로 수행하는 단계:

```
1. 📊 보안 취약점 분석
   ↓
2. 🔧 수정 방안 생성
   ↓
3. 📝 PR 템플릿 생성
   ↓
4. 🌿 새 브랜치 생성 (security-fixes)
   ↓
5. 💾 변경사항 커밋
   ↓
6. 🚀 원격 저장소에 푸시
   ↓
7. 🔀 GitHub PR 생성
   ↓
8. ✅ PR URL 반환
```

---

## 📊 예상 출력

### 성공 시:

```json
{
  "success": true,
  "pr_url": "https://github.com/qazz92/security-agent-test/pull/1",
  "branch": "security-fixes",
  "base_branch": "main",
  "message": "Pull Request created successfully",
  "commits": 1
}
```

### 실제 생성된 PR 예시:

**제목:** `🔒 Fix 12 Critical Security Vulnerabilities`

**본문:**
```markdown
## 📊 Summary
- **Total vulnerabilities fixed**: 12
- **Critical**: 4 🚨
- **High**: 6 ⚠️
- **Medium**: 2 📋

## 🔧 Changes Made
- Fixed SQL Injection in app.py:57
- Fixed XSS vulnerability in app.py:99
- Removed hardcoded secrets
- Updated Flask to 3.0.0
- Updated requests to 2.31.0

## 🧪 Testing
- [x] All existing tests pass
- [x] New security tests added
- [x] Trivy scan clean

## 🔒 Security Checklist
- [x] No hardcoded secrets
- [x] Input validation added
- [x] Parameterized queries used

🤖 Generated with SecurityAgent
```

---

## ❌ 문제 해결

### 에러: "GitHub CLI (gh) not installed"

**해결:**
```bash
brew install gh  # macOS
```

### 에러: "GitHub CLI not authenticated"

**해결:**
```bash
gh auth login
```

### 에러: "Failed to push to remote"

**원인:** 원격 저장소가 설정되지 않았거나 권한이 없음

**해결:**
```bash
# 원격 저장소 추가
git remote add origin https://github.com/qazz92/security-agent-test.git

# 권한 확인
gh repo view qazz92/security-agent-test
```

### 에러: "PR already exists"

**원인:** 같은 브랜치로 이미 PR이 생성됨

**해결:** 다른 브랜치 이름 사용
```python
create_github_pr._run(
    ...,
    branch_name="security-fixes-v2"  # 새 브랜치 이름
)
```

---

## 🎨 커스터마이징

### PR 브랜치 이름 변경

```python
result = create_github_pr._run(
    ...,
    branch_name="security-patch-2025-01"  # 커스텀 브랜치
)
```

### Base 브랜치 변경

```python
result = create_github_pr._run(
    ...,
    base_branch="develop"  # main 대신 develop
)
```

### PR 본문 커스터마이징

```python
custom_pr_body = """## 🔐 Custom Security Patch

### What changed
- Fixed vulnerabilities X, Y, Z

### Why
- To comply with security policies

### Testing
- Manual testing completed
- Automated tests passing

/cc @security-team
"""

result = create_github_pr._run(
    pr_body=custom_pr_body,
    ...
)
```

---

## 🔐 보안 고려사항

1. **GitHub Token 보안**
   - GitHub CLI가 안전하게 토큰 관리
   - `.env` 파일에 토큰 저장 불필요

2. **자동 커밋 내용**
   - 민감한 정보가 커밋되지 않도록 주의
   - `.gitignore` 설정 확인

3. **PR 권한**
   - Public 저장소: 누구나 PR 생성 가능
   - Private 저장소: Collaborator 권한 필요

---

## 📚 추가 기능

### GitHub Issue 생성

취약점을 Issue로 트래킹:

```python
from src.tools.github_tools import create_github_issue

result = create_github_issue._run(
    repo_url="https://github.com/qazz92/security-agent-test",
    issue_title="🐛 SQL Injection Vulnerability in app.py",
    issue_body="""## Description
SQL Injection vulnerability found in line 57.

## Impact
CRITICAL - Database compromise possible

## Recommendation
Use parameterized queries
    """,
    labels=["security", "critical", "bug"]
)
```

---

## 🎯 Best Practices

1. **PR 생성 전 로컬 테스트**
   ```bash
   pytest tests/
   trivy fs .
   ```

2. **의미있는 브랜치 이름**
   ```python
   branch_name="security-fix-sql-injection-2025-01"
   ```

3. **상세한 PR 설명**
   - 무엇을 고쳤는지
   - 왜 고쳤는지
   - 어떻게 테스트했는지

4. **팀 태그**
   ```markdown
   /cc @security-team @backend-team
   ```

---

## 🚀 다음 단계

PR이 생성되면:

1. ✅ **Code Review**: 팀원에게 리뷰 요청
2. ✅ **CI/CD 확인**: GitHub Actions 자동 실행 확인
3. ✅ **테스트 통과**: 모든 테스트가 통과하는지 확인
4. ✅ **Merge**: 리뷰 승인 후 병합
5. ✅ **배포**: Production 환경에 배포

---

## 💡 팁

- **자동화 스크립트**: Cron job으로 정기 스캔 및 PR 생성
- **Slack 알림**: PR 생성 시 Slack에 자동 알림
- **Jira 연동**: 취약점을 Jira 티켓으로 자동 생성

---

**이제 보안 취약점 수정이 완전히 자동화됩니다!** 🎉