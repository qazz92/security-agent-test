"""
GitHub PR ìë™ ìƒì„± í…ŒìŠ¤íŠ¸
"""
import asyncio
import sys
import os

sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from src.agents.orchestrator_agent import SecurityOrchestrator


async def main():
    """GitHub PR ìƒì„± í¬í•¨ ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸"""

    print("="*70)
    print("ğŸ” SecurityAgent - Automatic GitHub PR Creation Demo")
    print("="*70)
    print()
    print("ì´ ë°ëª¨ëŠ” ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:")
    print("1. ë³´ì•ˆ ì·¨ì•½ì  ë¶„ì„")
    print("2. ìˆ˜ì • ë°©ì•ˆ ìƒì„±")
    print("3. GitHubì— ìë™ìœ¼ë¡œ Pull Request ìƒì„±")
    print()
    print("âš ï¸  ì‚¬ì „ ìš”êµ¬ì‚¬í•­:")
    print("   - GitHub CLI (gh) ì„¤ì¹˜ í•„ìˆ˜")
    print("   - gh auth login ìœ¼ë¡œ ì¸ì¦ ì™„ë£Œ")
    print("   - Git repositoryê°€ https://github.com/qazz92/security-agent-test ì™€ ì—°ê²°ë˜ì–´ ìˆì–´ì•¼ í•¨")
    print("="*70)
    print()

    # ì‚¬ìš©ì í™•ì¸
    response = input("ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ")
    if response.lower() != 'y':
        print("ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
        return

    orchestrator = SecurityOrchestrator(verbose=True)

    # GitHub ì €ì¥ì†Œ URL í¬í•¨í•˜ì—¬ ë¶„ì„ ìš”ì²­
    query = """
    Comprehensive security analysis and remediation for GitHub repository:
    https://github.com/qazz92/security-agent-test

    After generating the remediation plan, please create an actual GitHub Pull Request
    with the security fixes.
    """

    result = await orchestrator.analyze_and_remediate(
        'demo/hello-world-vulnerable',
        query
    )

    print("\n" + "="*70)
    print("ğŸ“„ WORKFLOW RESULTS")
    print("="*70)

    if "error" not in result:
        analysis_summary = result.get("security_analysis", {}).get("analysis_summary", {})
        remediation_summary = result.get("remediation_plan", {}).get("remediation_summary", {})

        print(f"âœ… Total Vulnerabilities Found: {analysis_summary.get('total_vulnerabilities', 0)}")
        print(f"âœ… PR Template Created: {remediation_summary.get('pr_template_created', False)}")
        print(f"âœ… Documentation Created: {remediation_summary.get('documentation_created', False)}")

        # GitHub PR ìƒì„± ì—¬ë¶€ í™•ì¸
        detailed_remediation = result.get("remediation_plan", {}).get("detailed_remediation", {})
        pr_template = detailed_remediation.get("pr_template", "")

        print("\nğŸ“ Generated PR Template:")
        print("-" * 70)
        print(pr_template[:500] + "..." if len(pr_template) > 500 else pr_template)
        print("-" * 70)

    else:
        print(f"âŒ Error: {result.get('error')}")

    print("="*70)


async def test_pr_creation_directly():
    """GitHub PR ìƒì„± Toolì„ ì§ì ‘ í…ŒìŠ¤íŠ¸"""

    from src.tools.github_tools import create_github_pr

    print("\nğŸ§ª Testing GitHub PR creation directly...")

    pr_body = """## ğŸ” Security Patch

### Summary
- Fixed 12 critical security vulnerabilities
- Updated dependencies with known CVEs
- Added input validation and sanitization

### Testing
- [x] All existing tests pass
- [x] Security scan clean

### Checklist
- [x] No hardcoded secrets
- [x] Input validation added
- [x] Database queries use parameterized statements

ğŸ¤– Generated by SecurityAgent
"""

    result = create_github_pr._run(
        repo_url="https://github.com/qazz92/security-agent-test",
        pr_title="ğŸ”’ Fix Critical Security Vulnerabilities",
        pr_body=pr_body,
        branch_name="security-fixes-auto",
        base_branch="main"
    )

    print("\nğŸ“Š PR Creation Result:")
    print(result)


if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(description="GitHub PR ìë™ ìƒì„± í…ŒìŠ¤íŠ¸")
    parser.add_argument(
        '--direct',
        action='store_true',
        help="Toolì„ ì§ì ‘ í…ŒìŠ¤íŠ¸ (ì „ì²´ ì›Œí¬í”Œë¡œìš° ìŠ¤í‚µ)"
    )

    args = parser.parse_args()

    if args.direct:
        asyncio.run(test_pr_creation_directly())
    else:
        asyncio.run(main())